version: '3.8'

services:
  panel:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pterodactyl-panel
    restart: unless-stopped
    ports:
      - "80:8080"
    environment:
      APP_URL: "http://localhost"
      APP_TIMEZONE: "Asia/Jakarta"
      APP_ENV: "production"
      APP_DEBUG: "false"
      
      # Database
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: pterodactyl
      DB_USERNAME: pterodactyl
      DB_PASSWORD: pterodactyl_password
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      
      # Cache & Session
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      
      # Mail (optional - configure as needed)
      MAIL_DRIVER: smtp
      MAIL_HOST: smtp.mailtrap.io
      MAIL_PORT: 2525
      MAIL_FROM: noreply@example.com
      MAIL_USERNAME: ""
      MAIL_PASSWORD: ""
      MAIL_ENCRYPTION: tls
      
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - panel_data:/var/www/pterodactyl/storage/app
      - panel_logs:/var/www/pterodactyl/storage/logs

  mysql:
    image: mysql:8.0
    container_name: pterodactyl-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: pterodactyl
      MYSQL_USER: pterodactyl
      MYSQL_PASSWORD: pterodactyl_password
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7.2-alpine
    container_name: pterodactyl-redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  mysql_data:
  panel_data:
  panel_logs:
